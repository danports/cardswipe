/*!
 * vue-cardswipe v0.1.1 
 * (c) 2019 Michael Wuori
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.VueCardswipe=t()}(this,function(){"use strict";var e={cardSwipe:void 0,settings:{},init:function(t){return e.methods.init(t)},builtinParsers:{generic:function(e){var t=new RegExp("^(%[^%;\\?]+\\?)?(;[0-9\\:<>\\=]+\\?)?([+;][0-9\\:<>\\=]+\\?)?"),s=t.exec(e);return s?{type:"generic",line1:s[1]?s[1].slice(1,-1):"",line2:s[2]?s[2].slice(1,-1):"",line3:s[3]?s[3].slice(1,-1):""}:null},visa:function(t){var s=new RegExp("^%B(4[0-9]{12,18})\\^([A-Z ]+)/([A-Z ]+)(\\.[A-Z ]+)?\\^([0-9]{2})([0-9]{2})"),r=s.exec(t);if(!r)return null;var n=r[1];return e.luhnChecksum(n)?{type:"visa",account:n,lastName:r[2].trim(),firstName:r[3].trim(),honorific:r[4]?r[4].trim().slice(1):"",expYear:r[5],expMonth:r[6]}:null},mastercard:function(t){var s=new RegExp("^%B(5[1-5][0-9]{14})\\^([A-Z ]+)/([A-Z ]+)(\\.[A-Z ]+)?\\^([0-9]{2})([0-9]{2})"),r=s.exec(t);if(!r)return null;var n=r[1];return e.luhnChecksum(n)?{type:"mastercard",account:n,lastName:r[2],firstName:r[3],honorific:r[4]?r[4].trim().slice(1):"",expYear:r[5],expMonth:r[6]}:null},discover:function(t){var s=new RegExp("^%B(6[0-9]{15})\\^([A-Z ]+)/([A-Z ]+)(\\.[A-Z ]+)?\\^([0-9]{2})([0-9]{2})"),r=s.exec(t);if(!r)return null;var n=r[1];return e.luhnChecksum(n)?{type:"discover",account:n,lastName:r[2],firstName:r[3],honorific:r[4]?r[4].trim().slice(1):"",expYear:r[5],expMonth:r[6]}:null},amex:function(t){var s=new RegExp("^%B(3[4|7][0-9]{13})\\^([A-Z ]+)/([A-Z ]+)(\\.[A-Z ]+)?\\^([0-9]{2})([0-9]{2})"),r=s.exec(t);if(!r)return null;var n=r[1];return e.luhnChecksum(n)?{type:"amex",account:n,lastName:r[2],firstName:r[3],honorific:r[4]?r[4].trim().slice(1):"",expYear:r[5],expMonth:r[6]}:null}},states:{IDLE:0,PENDING1:1,PENDING2:2,READING:3,DISCARD:4,PREFIX:5},stateNames:{0:"IDLE",1:"PENDING1",2:"PENDING2",3:"READING",4:"DISCARD",5:"PREFIX"},currentState:0,state:function(){if(0===arguments.length)return e.currentState;var t=arguments[0];if(t!=e.state){if(e.settings.debug&&console.log("%s -> %s",e.stateNames[e.currentState],e.stateNames[t]),t==e.states.READING){var s=new CustomEvent("scanstart.cardswipe");document.dispatchEvent(s)}if(e.currentState==e.states.READING){var r=new CustomEvent("scanend.cardswipe");document.dispatchEvent(r)}e.currentState=t}},scanbuffer:[],timerHandle:0,listener:function(t){switch(e.settings.debug&&console.log(t.which+": "+String.fromCharCode(t.which)),e.state()){case e.states.IDLE:e.isInPrefixCodes(t.which)&&(e.state(e.states.PREFIX),t.preventDefault(),t.stopPropagation(),e.startTimer()),37==t.which&&(e.state(e.states.PENDING1),e.scanbuffer=[],e.processCode(t.which),t.preventDefault(),t.stopPropagation(),e.startTimer()),59==t.which&&(e.state(e.states.PENDING2),e.scanbuffer=[],e.processCode(t.which),t.preventDefault(),t.stopPropagation(),e.startTimer());break;case e.states.PENDING1:if(t.which>=65&&t.which<=90||t.which>=97&&t.which<=122){e.state(e.states.READING);var s=document.querySelector(":focus");s&&s.blur(),e.processCode(t.which),t.preventDefault(),t.stopPropagation(),e.startTimer()}else e.clearTimer(),e.scanbuffer=null,e.state(e.states.IDLE);break;case e.states.PENDING2:t.which>=48&&t.which<=57?(swipeData.state(e.states.READING),$("input").blur(),e.processCode(t.which),t.preventDefault(),t.stopPropagation(),e.startTimer()):(e.clearTimer(),e.scanbuffer=null,e.state(e.states.IDLE));break;case e.states.READING:e.processCode(t.which),e.startTimer(),t.preventDefault(),t.stopPropagation(),13==t.which&&(e.clearTimer(),e.state(e.states.IDLE),e.processScan()),e.settings.firstLineOnly&&63==t.which&&(e.state(e.states.DISCARD),e.processScan());break;case e.states.DISCARD:if(t.preventDefault(),t.stopPropagation(),13==t.which)return e.clearTimer(),void e.state(e.states.IDLE);e.startTimer();break;case e.states.PREFIX:if(e.isInPrefixCodes(t.which))return void e.state(states.IDLE);t.preventDefault(),t.stopPropagation(),37==t.which&&(e.state(states.PENDING1),e.scanbuffer=[],e.processCode(t.which)),59==t.which&&(e.state(states.PENDING2),e.scanbuffer=[],e.processCode(t.which)),e.startTimer()}},processCode:function(t){e.scanbuffer.push(String.fromCharCode(t))},startTimer:function(){clearTimeout(e.timerHandle),e.timerHandle=setTimeout(e.onTimeout,e.settings.interdigitTimeout)},clearTimer:function(){clearTimeout(e.timerHandle),e.timerHandle=0},onTimeout:function(){e.settings.debug&&console.log("Timeout!"),e.state()==e.states.READING&&e.processScan(),e.scanbuffer=null,e.state(states.IDLE)},processScan:function(){e.settings.debug&&console.log(e.scanbuffer);var t=e.scanbuffer.join("");e.settings.rawDataCallback&&settings.rawDataCallback.call(this,t);var s=e.parseData(t);if(s){e.settings.success&&e.settings.success.call(this,s);var r=new CustomEvent("success.cardswipe",{detail:{result:s}});document.dispatchEvent(r)}else e.settings.failure&&settings.failure.call(this,t),document.dispatchEvent("failure.cardswipe")},parseData:function(t){for(var s=this,r=0;r<e.settings.parsers.length;r++){var n=e.settings.parsers[r];console.log("ref",n);var i=void 0;if("function"==typeof n?i=n:"string"==typeof n&&(i=e.builtinParsers[n]),null!=i){var a=i.call(s,t);if(null==a)continue;return a}}return null},bindListener:function(){$(document).on("keypress.cardswipe-listener",e.listener)},unbindListener:function(){$(document).off(".cardswipe-listener",e.listener)},defaultSuccessCallback:function(e){var t=["Line 1: ",e.line1,"\nLine 2: ",e.line2,"\nLine 3: ",e.line3].join("");alert(t)},isInPrefixCodes:function(t){return!!e.settings.prefixCodes&&-1!=$.inArray(t,e.settings.prefixCodes)},luhnChecksum:function(e){for(var t=[0,2,4,6,8,1,3,5,7,9],s=0,r=e.length,n=!0;r--;){var i=parseInt(e.charAt(r),10);s+=n?i:t[i],n=!n}return s%10==0&&s>0},methods:{init:function(t){var s=this,r={enabled:!0,interdigitTimeout:250,success:e.defaultSuccessCallback,failure:null,parsers:["visa","mastercard","amex","discover","generic"],firstLineOnly:!1,prefixCharacter:null,debug:!1};if(e.settings=$.extend({},r,t),e.settings.prefixCharacter){"[object Array]"===Object.prototype.toString.call(e.settings.prefixCharacter)||(e.settings.prefixCharacter=[settings.prefixCharacter]),e.settings.prefixCodes=[];for(var n in e.settings.prefixCharacter){if(1!=e.settings.prefixCharacter[n].length)throw"prefixCharacter must be a single character";settings.prefixCodes.push(s.charCodeAt(0))}}e.clearTimer(),e.state(e.states.IDLE),e.scanbuffer=null,e.unbindListener(),e.settings.enabled&&e.methods.enable()},disable:function(){e.unbindListener()},enable:function(){e.bindListener()}}},t={install:function(t,s){Vue.prototype.$cardSwipe=e}};return"undefined"!=typeof window&&window.Vue&&window.Vue.use(t),e});